#!/usr/bin/ruby
if ARGV[0]
  unless File.file?(ARGV[0])
    puts "Can't find base ruby file"
    exit 1
  end
  require ARGV[0]
else
  unless File.file?("../lib/base.rb")
    puts "Can't find base ruby file"
    exit 1
  end
  require_relative "../lib/base.rb"
end

# set image tag if it hasnt been set
required_env("DOCKER_USERNAME")
required_env("DOCKER_PASSWORD")
required_env("DOCKER_IMAGE")

env_check("IMAGE_TAG", `git rev-parse HEAD`)
env_check("DOCKER_REGISTRY", "https://hub.docker.com")

# login to docker hub
command('docker login -u "$DOCKER_USERNAME" -p "$DOCKER_PASSWORD" $DOCKER_REGISTRY')

# build docker image
command('docker build --pull -t "$DOCKER_IMAGE:$IMAGE_TAG" .')

# push docker image
command('docker push "$DOCKER_IMAGE:$IMAGE_TAG"')
